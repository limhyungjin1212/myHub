<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lhj.mapper.BoardMapper">
	<select id="boardList" resultType="com.lhj.model.BoardVO">
		select * from product_board
	</select>

	<insert id="boardWrite">
		insert into product_board(pname,pcate,ptel,pinfo,place) 
		values(#{pname},#{pcate},#{ptel},#{pinfo},#{place})
	</insert>


	<!-- 전체 게시글 갯수  -->
	<select id="boardCount" resultType="int">
		select count(*) from product_board
		<!-- <if test="keyword !=null">
			where subject like concat('%',#{keyword},'%')
		</if> -->
		<include refid="keyword"></include>
		<include refid="place"></include>			
	</select>
	
<sql id="keyword">
		<if test="keyword != null">
				where (pcate like concat('%',trim(#{keyword}),'%') or pname like concat('%',trim(#{keyword}),'%')) 
		</if>
</sql>
<sql id="place">
		<if test="place != null">
				and place like concat('%',trim(#{place}),'%')  
		</if>
</sql>


	<!-- rownum을 이용한 페이징  -->
	<select id="boardListPage" resultType="com.lhj.model.BoardVO">
		select pno , pname, pcate ,ptel, pinfo , regdate
			from (
				select @rownum:=@rownum+1 as rownum , pno, pname, pcate , pinfo, ptel , regdate
				from (select @rownum:=0) as rownum , product_board
				<!-- <if test="keyword != null">
				where subject like concat('%',trim(#{keyword}),'%')
				</if> -->
				<include refid="keyword"></include>
				order by pno desc
			) product_board 
				<![CDATA[
			where rownum >(#{pageNum}-1)*#{amount} and rownum<=#{amount}*#{pageNum} 
		]]>
	</select>
	
	<!-- 상세보기  -->
	<select id="boardDetail" resultType="com.lhj.model.BoardVO">
		<!--리뷰가 없을경우 null값을 0으로 대체하고 평균 평점을 round함수로 반올림한다.  -->
		select ifnull(round(avg(rate),1),0) as rate , p.* from product_board p left join review r on p.pno=r.pno where p.pno= #{pno}
	</select>
	
	<!-- 수정  -->
	<update id="boardUpdate">
		update product_board set pcate = #{pcate}, ptel = #{ptel} , pinfo = #{pinfo} where pno = #{pno}	
	</update>
	
	
	<!-- 삭제  -->
	<delete id="boardDelete">
		delete from product_board where pno = #{pno}
	</delete>
	
	<!--게시판 파일 업로드  -->
	<insert id="addAttach">
		insert into attach(filename,pno) values (#{filename},LAST_INSERT_ID())
	</insert>
	
	<!-- 파일 이름 가져오기  -->
	<select id="getAttach" resultType="string">
		select * from attach where pno = #{pno};
	</select>
	
	<!-- 게시글과 파일 가져오기  -->
	<select id="boardListAttach" resultType="com.lhj.model.BoardVO" >
		select * from (select B.* , @rownum:=@rownum+1 as rownum from (
		select 	p.pno, p.pname, p.pcate , p.pinfo, p.ptel , p.regdate , p.place,a.filename as fn , ifnull(round(avg(re.rate),1),0) as rate , (select count(rno) from review where pno = p.pno) as rcnt 
				from product_board p left join attach a on (p.pno = a.pno) left join review as re on (re.pno = p.pno) join (select @rownum:=0) as R 
						<include refid="keyword"></include>
						<include refid="place"></include>
						group by p.pno ) 
                        as B
                order by B.regdate desc) as C 
			<![CDATA[
			where rownum >(#{pageNum}-1)*#{amount} and rownum<=#{amount}*#{pageNum} 
		]]> 
	</select>
	
	<!-- 파일 삭제 -->
	<delete id="deleteAttach">
		delete from attach where pno = #{pno}
	</delete>	
	
	<insert id="replaceAttach">
		insert into attach(filename,pno) values(#{filename},#{pno})
	</insert>
	
	
	
</mapper>